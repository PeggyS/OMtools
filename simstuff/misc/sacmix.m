% sacmix.m: automatic control of "sacmixmdl.mdl," a model that% mixes saccades with/against velocity ramps.  Part of the% "BS Char in CN" paper, examining the effect on saccadic% magnitude when saccades are made in the presence of an % opposing or reinforcing slow phase.  This program will% run the model over a range of saccadic commands and % slow phases, and calculate the resulting saccades' properties% and present this info in a graph and a table.% Written by:  Jonathan Jacobs%              April 1998 - August 2000  (last mod: 08/21/00)saccThresh = 5;  % sacc starts when vel > x¡/sec beyond baselinesimstop = 1.0;sstate = 0.75;modelName  = 'pls_sld_stp_vel';  % 2p1z%modelName = 'sacMixMdl';        % 2p, complex OMN%modelName = 'sacMixMdl2';       % 2p, OMN = simple summation%sacCmdList  = [-20];%sacCmdList  = [1 2 3 4 5 10 15 20];sacCmdList  = [-20 -15 -10 -5 -4 -3 -2 -1 1 2 3 4 5 10 15 20];%velStepList = [-50];%velStepList = [-50 -25 -10 0 10 25 50];velStepList = [50 25 10 0 -10 -25 -50];%velStepList = [50 25 10 0];%velStepList = [0 -10 -25 -50];dur = zeros(length(sacCmdList), length(velStepList));saccmag = zeros(length(sacCmdList), length(velStepList));saccmag2 = zeros(length(sacCmdList), length(velStepList));saccmag2old = zeros(length(sacCmdList), length(velStepList));tic;for i = 1:length(velStepList)   velStep = velStepList(i);   disp(['Slow phase = ' num2str(velStep) '¡/sec'])   for j = 1:length(sacCmdList)      sacCmd = sacCmdList(j);      drawnow      % modern way to specify simulation params      % make sure these values agree with those in model's param menu      simopts = simset('Solver','ode4','FixedStep',0.001);      [a,b] = sim(modelName,[0 simstop], simopts);            % find the saccade magnitudes and durations.      % 1000 Hz 'sampling' rate, step starts at 0.25 sec      % we will try to determine them by two methods:       % 1) velocity criteria and 2) position criteria            % 1) velocity criteria       % find the onset and offset points.  this isn't always straightforward      % because there can be spurious pts beyond (baseline±threshold)      % look at vel trace for sacc on/off      velpts  = d2pt(out,2,1000);      saccSeg = velpts(250:350);      if sacCmd < 0         temp = find( saccSeg<(velStep-saccThresh) );       elseif sacCmd > 0         temp = find( saccSeg>(velStep+saccThresh) );       else          disp('Hey! No saccade!');          break      end            % look for discontinuities in "temp" array      tempa = [0; temp];      tempb = [temp; 0];      tempc = tempa - tempb;      tempd = tempc(2:end)+1;      badpts = find(tempd ~= 0);      badpts = badpts + 249;      temp = temp + 249;      sacon(j,i) = temp(1);                  sacoff(j,i) = badpts(1);                  dur(j,i) = sacoff(j,i)-sacon(j,i);       %saccmag(j,i) = out(sacoff(j,i)) - out(sacon(j,i));                  %%%%%%%%%%%%%%      % 2) position criteria (case: sacc in opposite direction as ramp)      if sign(sacCmd) ~= sign(velStep)	     startseg = out(250:260);	     endseg   = out(261:350);	     if sign(velStep)<0	        startpts = find(startseg == min(startseg))+249;	        stoppts  = find(endseg == max(endseg))+260;	      elseif sign(velStep)>0	        startpts = find(startseg == max(startseg))+249;	        stoppts  = find(endseg == min(endseg))+260;	      else	        startpts = 100;	        stoppts  = 900; 	     end          	     sacon2(j,i) = startpts(end);	     sacoff2(j,i) = stoppts(1);	     dur2(j,i) = sacoff2(j,i) - sacon2(j,i); 	     saccmag2(j,i) = out(sacoff2(j,i)) - out(sacon2(j,i));       else	     % find the sacc mag when the ramp and the step are in the same direction	     % and also if they are in opposite directions (compare to other method)	     prept = [100 200];	     slopePre  = 1000*(out(prept(2))-out(prept(1))) / (prept(2)-prept(1));	     	     % calc 'dur3':	     % 1. find the velocity at 251 ms (sacon)         % 2. find the time when vel drops back to that value         % 3. take position at this time index (sacoff)         sacon3(j,i) = 251;         vthresh = abs(velpts(sacon3(j,i)));         offseg = abs(velpts(255:350));         offpts = find(offseg<=vthresh);         sacoff3(j,i) = offpts(1)+254;         dur3(j,i) = sacoff3(j,i) - sacon3(j,i); 	     % extend the initial ramp to 'sstate' seconds.	     % calc w/a segment parallel to the actual saccade	     extenPre(j,i)  = out(prept(1)) + slopePre*(sstate-prept(1)/1000);         saccmag2(j,i) = out(sstate*1000+dur3(j,i)) - extenPre(j,i);         % how does it look?   		 if (0)   		    figure		    plot( (0:1000)/1000, out)		    hold on		    linePre = line([prept(1)/1000 sstate], [out(prept(1)+1) extenPre(j,i)]);		    lineMag = line([sstate sstate+dur3(j,i)/1000],...		                   [extenPre(j,i) out(sstate*1000+dur3(j,i))]);		    set(linePre,'Color','w')		    set(linePre,'LineStyle','--')		    set(lineMag,'Color','w')		    set(lineMag,'LineStyle','--')		 end      end            disp([prepad(num2str(sacCmd),6) '¡   '...            prepad(num2str(saccmag2(j,i)),10) '¡  '...            prepad(num2str(dur(j,i)), 8) ' msec'])   end         % turn this on to plot outputs   if (0)      plot( (0:1000)/1000, out)	  hold on   end   disp(' ')enddisp(['Simulation time: ' num2str(toc) ' seconds.']);% if you want to make a shiny graph...% 'saccmag2' is oriented so that the columns are the ramp velocities,% and the rows are the saccade commands % (you may wish to just plot a portion of these arrays)% this order of arguments will plot a family of lines% each line is the result of the simulations for a given ramp velocity% and the points on each line are the actual magnitude of executed saccades% e.g. to plot the "with" results (for POSITIVE saccades):% plot(sacCmdList(1:8), saccmag2(1:8,1:4))% e.g. to plot the "against" results (for POSITIVE saccades):% plot(sacCmdList(9:16), saccmag2(9:16,1:4))% plot a 45¡ equality line% a=line([0 20], [0 20]);% set(a,'Color','w')% set(a,'LineStyle','--')